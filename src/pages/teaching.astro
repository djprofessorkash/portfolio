---
import BaseLayout from "../layouts/BaseLayout.astro";
import DynamicBGAnim from "../components/DynamicBGAnim.astro";
import teachingData from "../data/teaching.json";

const teaching = teachingData.teaching;
const subjectsFiltering = teachingData.subjectsFiltering;
---

<BaseLayout title="Teaching - Aakash Sudhakar" description="Explore my teaching experiences across computer science, data science, and digital humanities." type="website">
    <div class="relative min-h-screen">
        <DynamicBGAnim />
        
        <!-- Teaching Container -->
        <div class="relative z-20 py-20 px-6 md:px-12 lg:px-20">
            <!-- Subject Filters -->
            <div class="mb-12 flex justify-end">
                <div id="subject-filters" class="flex items-center gap-1 text-xs font-poppins text-pearl/50 uppercase">
                    <button
                        class="subject-filter font-semibold transition-all duration-300 hover:text-pearl cursor-pointer text-pearl"
                        data-subject="ALL"
                    >
                        ALL
                    </button>
                    {subjectsFiltering.map((subject, index) => (
                        <>
                            <span class="text-pearl/30 mx-0.5">/</span>
                            <button
                                class="subject-filter font-semibold transition-all duration-300 hover:text-pearl cursor-pointer"
                                data-subject={subject.value}
                            >
                                {subject.display}
                            </button>
                        </>
                    ))}
                </div>
            </div>

            <!-- Teaching Grid -->
            <div id="teaching-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 lg:gap-4 max-w-4xl mx-auto">
                <!-- Teaching items will be loaded dynamically -->
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-pearl"></div>
            </div>
        </div>

        <!-- Hidden data for client-side rendering -->
        <script type="application/json" id="teaching-data" set:html={JSON.stringify(teaching)} />
        <script type="application/json" id="subjects-data" set:html={JSON.stringify(subjectsFiltering)} />

        <!-- Teaching Detail Modal -->
        <div id="teaching-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 backdrop-blur-md p-4">
            <div class="relative w-full max-w-5xl max-h-[90vh] bg-silver rounded-2xl shadow-2xl overflow-hidden">
                <!-- Close Button -->
                <button 
                    id="close-modal" 
                    class="absolute top-4 right-4 z-10 bg-black/50 hover:bg-black/70 text-pearl rounded-full p-3 transition-all duration-300 hover:scale-110"
                    aria-label="Close modal"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- Modal Content -->
                <div class="overflow-y-auto max-h-[90vh]">
                    <div class="grid md:grid-cols-5 gap-0">
                        <!-- Image Section -->
                        <div class="relative md:col-span-2 h-64 md:h-full">
                            <img 
                                id="modal-image" 
                                src="" 
                                alt="" 
                                class="w-full h-full object-cover"
                            />
                        </div>

                        <!-- Content Section -->
                        <div class="md:col-span-3 p-8 md:p-10 flex flex-col">
                            <!-- Course Name -->
                            <h2 id="modal-title" class="text-3xl md:text-4xl font-bold font-poppins text-pearl mb-4">
                            </h2>

                            <!-- Tagline -->
                            <p id="modal-tagline" class="text-lg md:text-xl font-medium font-poppins text-pearl/80 mb-6 italic">
                            </p>

                            <!-- Topics -->
                            <p id="modal-topics" class="text-base font-poppins text-pearl/90 mb-8 leading-relaxed">
                            </p>

                            <!-- Subjects -->
                            <div class="mb-8">
                                <h3 class="text-sm font-bold font-poppins text-pearl/70 mb-4 uppercase tracking-wider">
                                    Subjects
                                </h3>
                                <div id="modal-subjects" class="flex flex-wrap gap-2">
                                    <!-- Subject tags will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .teaching-card {
        animation: fadeInUp 0.6s ease-out forwards;
        opacity: 0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Get data from script tags
        const teachingData = JSON.parse(document.getElementById('teaching-data')?.textContent || '[]');
        const subjectsData = JSON.parse(document.getElementById('subjects-data')?.textContent || '[]');

        // DOM elements
        const teachingGrid = document.getElementById('teaching-grid');
        const modal = document.getElementById('teaching-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const loadingIndicator = document.getElementById('loading-indicator');

        // State
        let allTeaching = teachingData;
        let filteredTeaching: any[] = [];
        let currentIndex = 0;
        let isLoading = false;
        let activeFilter = 'ALL';

        const INITIAL_LOAD = 6;
        const TEACHING_PER_LOAD = 6;

        // Create teaching card with preloading
        function createTeachingCard(teachingItem: any): Promise<HTMLElement> {
            return new Promise((resolve) => {
                const article = document.createElement('article');
                article.className = 'teaching-card group cursor-pointer transition-all duration-300 hover:scale-105';
                
                // Create image elements for preloading
                const img1 = new Image();
                const img2 = new Image();
                let loadedCount = 0;
                
                const checkLoaded = () => {
                    loadedCount++;
                    if (loadedCount >= 2 || loadedCount >= 1) {
                        article.innerHTML = `
                            <div class="relative aspect-square overflow-hidden bg-silver">
                                <!-- Base image -->
                                <img 
                                    src="${teachingItem.imageURLOnDisplay}" 
                                    alt="${teachingItem.name}"
                                    class="absolute inset-0 w-full h-full object-cover transition-all duration-500 group-hover:scale-110 group-hover:opacity-0"
                                />
                                <!-- Hover image -->
                                <img 
                                    src="${teachingItem.imageURLOnHover}" 
                                    alt="${teachingItem.name}"
                                    class="absolute inset-0 w-full h-full object-cover transition-all duration-500 opacity-0 group-hover:opacity-100 group-hover:scale-110"
                                />
                                <!-- Hover overlay with title and subjects -->
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/70 transition-all duration-300 flex flex-col items-center justify-center p-4 gap-2">
                                    <h2 class="text-sm md:text-base font-bold font-poppins text-pearl text-center leading-snug opacity-0 group-hover:opacity-100 invisible group-hover:visible translate-y-8 group-hover:translate-y-0 transition-all duration-300">
                                        ${teachingItem.name}
                                    </h2>
                                    <p class="text-xs font-medium font-poppins text-pearl/80 text-center uppercase tracking-wide opacity-0 group-hover:opacity-100 invisible group-hover:visible translate-y-8 group-hover:translate-y-0 transition-all duration-300 delay-75">
                                        ${teachingItem.subjects.join(', ')}
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        // Add click handler
                        article.addEventListener('click', () => {
                            openModal(teachingItem);
                        });
                        
                        resolve(article);
                    }
                };
                
                img1.onload = checkLoaded;
                img2.onload = checkLoaded;
                
                img1.onerror = () => {
                    // If image fails to load, still create the card
                    checkLoaded();
                };
                
                img2.onerror = () => {
                    // If image fails to load, still create the card
                    checkLoaded();
                };
                
                img1.src = teachingItem.imageURLOnDisplay;
                img2.src = teachingItem.imageURLOnHover;
            });
        }

        // Filter teaching based on active filter and isActive status
        function updateFilteredTeaching() {
            const activeTeaching = allTeaching.filter((teachingItem: any) => teachingItem.isActive);
            
            if (!activeFilter || activeFilter === 'ALL') {
                filteredTeaching = activeTeaching;
            } else {
                filteredTeaching = activeTeaching.filter((teachingItem: any) => {
                    return teachingItem.subjects.includes(activeFilter);
                });
            }
        }

        // Load teaching items into grid
        async function loadTeaching(count: number) {
            if (isLoading || currentIndex >= filteredTeaching.length) return;
            
            isLoading = true;
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            
            const endIndex = Math.min(currentIndex + count, filteredTeaching.length);
            const cardPromises = [];
            
            // Create all cards and wait for images to preload
            for (let i = currentIndex; i < endIndex; i++) {
                cardPromises.push(createTeachingCard(filteredTeaching[i]));
            }
            
            const cardsToAdd = await Promise.all(cardPromises);
            
            // Add cards with staggered animation delays after images are loaded
            cardsToAdd.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.15}s`;
                teachingGrid?.appendChild(card);
            });
            
            currentIndex = endIndex;
            isLoading = false;
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        }

        // Check if user scrolled near bottom
        function checkScroll() {
            if (isLoading || currentIndex >= filteredTeaching.length) return;
            
            const scrollPosition = window.innerHeight + window.scrollY;
            const threshold = document.documentElement.scrollHeight - 500;
            
            if (scrollPosition >= threshold) {
                loadTeaching(TEACHING_PER_LOAD);
            }
        }

        // Modal functions
        function openModal(teachingData: any) {
            if (!modal) return;
            
            document.getElementById('modal-title')!.textContent = teachingData.name;
            document.getElementById('modal-tagline')!.textContent = teachingData.tagline;
            document.getElementById('modal-topics')!.textContent = teachingData.topics;
            document.getElementById('modal-image')!.setAttribute('src', teachingData.imageURLOnExpand);
            document.getElementById('modal-image')!.setAttribute('alt', teachingData.name);
            
            // Subjects
            const subjectsContainer = document.getElementById('modal-subjects');
            if (subjectsContainer) {
                subjectsContainer.innerHTML = '';
                teachingData.subjects.forEach((subject: string) => {
                    const span = document.createElement('span');
                    span.className = 'px-4 py-2 text-sm font-semibold font-poppins bg-pearl text-silver rounded-full';
                    span.textContent = subject;
                    subjectsContainer.appendChild(span);
                });
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            if (!modal) return;
            
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
        }

        // Close modal handlers
        closeModalBtn.addEventListener('click', closeModal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Subject filter handlers
        const filterButtons = document.querySelectorAll('.subject-filter');
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const subject = button.getAttribute('data-subject');
                if (!subject) return;

                // Deselect all filters
                filterButtons.forEach(btn => {
                    btn.classList.remove('text-pearl');
                    btn.classList.add('text-pearl/50');
                });

                // Select clicked filter
                button.classList.remove('text-pearl/50');
                button.classList.add('text-pearl');
                activeFilter = subject;

                // Reset and reload with filtered teaching
                updateFilteredTeaching();
                currentIndex = 0;
                if (teachingGrid) teachingGrid.innerHTML = '';
                loadTeaching(INITIAL_LOAD);
            });
        });

        // Scroll event listener
        window.addEventListener('scroll', checkScroll);

        // Initialize filtered teaching and load initial teaching items
        updateFilteredTeaching();
        loadTeaching(INITIAL_LOAD);
    });
</script>