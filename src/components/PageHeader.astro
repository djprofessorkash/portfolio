---
/**
 * Page Header Component
 * 
 * Provides the main navigation bar with logo, page routing links, and responsive burger menu.
 * Supports both desktop (horizontal nav bar) and mobile (collapsible burger menu) layouts.
 * Highlights the current active page in the navigation based on the URL pathname.
 */

// Capture the current URL pathname to determine which navigation link should be highlighted.
const currentPath = new URL(Astro.request.url).pathname;
console.log(currentPath);
---

<!-- 
  Navigation Bar Container (Desktop Layout)
  Rendered by default on large windows with horizontal layout and full navigation options.
-->
<nav
    id="headerNavBar"
    class="nav relative z-20 px-4 py-4 flex justify-between items-center"
>
    <!-- Clickable Logo on Header that Routes Back to Home Page -->
    <a class="text-3xl font-bold leading-none focus:outline-none" href="/" title="Back to Home" style="-webkit-tap-highlight-color: transparent;">
        <div class="relative w-[64px] h-[64px] duration-300 overflow-hidden opacity-80">
            <!-- Background circle that transitions to dynamic theme color on hover -->
            <div
                class="absolute inset-0 bg-pearl dynamic-bg-hover rounded-full"
            >
            </div>

            <!-- 
              Static logo image displaying the left portion of the combined logo.
              No hover effect - remains consistent across all states.
              Starts with silver background and fades in once image is loaded.
            -->
            <div
                id="desktopLogoImage"
                class="absolute inset-0 bg-no-repeat bg-left bg-cover opacity-0 transition-opacity duration-300"
                style="background-color: #3C454D; background-image: url('/media/home-logo.svg');"
            >
            </div>
        </div>
    </a>

    <!-- 
      Burger Menu Toggle Button (Mobile Only)
      Displayed only on small screens to access the collapsible navigation menu.
      Hidden by default on larger viewport sizes where the full nav bar is visible.
    -->
    <div class="lg:hidden">
        <button
            class="navbar-burger flex items-center text-pearl dark:text-pearl p-3"
        >
            <svg
                class="block h-4 w-4 fill-current"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
            >
                <title>Navigational Menu</title>
                <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path>
            </svg>
        </button>
    </div>

    {currentPath === "/" && (
    <!-- 
      Animation Title Display with Dropdown (Desktop)
      Shows the current background animation mode with dropdown to select specific modes.
      Top-right on desktop aligned with navigation.
    -->
    <div 
        id="animationModeTitle"
        class="hidden lg:block absolute top-[48px] right-4 transform -translate-y-1/2 font-code text-sm cursor-pointer"
        style="z-index: 100;"
    >
        <div 
            id="animationModeTitleButton"
            class="px-4 py-2 rounded-lg border-2 transition-all duration-300 hover:animate-pulse flex items-center gap-2"
            style="background-color: rgba(0, 0, 0, 0.35); border-color: var(--theme-hover-color); color: #e5e7eb; white-space: nowrap;"
        >
            <span id="animationModeTitleText">fractal frenetics</span>
            <svg id="dropdownArrow" class="w-3 h-3 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        
        <!-- Dropdown menu -->
        <div 
            id="animationDropdown"
            class="hidden absolute top-full right-0 mt-2 rounded-lg border-2 overflow-hidden"
            style="background-color: rgba(0, 0, 0, 0.35); border-color: var(--theme-hover-color); min-width: 200px;"
        >
            <div 
                class="animation-option px-4 py-2 transition-colors duration-200 cursor-pointer"
                style="color: #bae6fd;"
                data-mode="fractal"
            >fractal frenetics</div>
            <div 
                class="animation-option px-4 py-2 transition-colors duration-200 cursor-pointer"
                style="color: #D9BE4C;"
                data-mode="planets"
            >obstinate orbits</div>
            <div 
                class="animation-option px-4 py-2 transition-colors duration-200 cursor-pointer"
                style="color: #C4A574;"
                data-mode="sandfield"
            >rippling rhythms</div>
            <div 
                class="animation-option px-4 py-2 transition-colors duration-200 cursor-pointer"
                style="color: #FF6B9D;"
                data-mode="tron"
            >pageantic pursuers</div>
            <div 
                class="animation-option px-4 py-2 transition-colors duration-200 cursor-pointer"
                style="color: #A78BFA;"
                data-mode="portal"
            >galvanic gates</div>
        </div>
    </div>
    
    <!-- Mobile version - centered at top -->
    <div 
        id="animationModeTitleMobile"
        class="lg:hidden absolute top-2 left-1/2 transform -translate-x-1/2 font-code text-xs cursor-pointer"
        style="z-index: 100;"
    >
        <div 
            id="animationModeTitleButtonMobile"
            class="px-3 py-1.5 rounded-lg border-2 transition-all duration-300 hover:animate-pulse flex items-center gap-2"
            style="background-color: rgba(0, 0, 0, 0.35); border-color: var(--theme-hover-color); color: #e5e7eb; white-space: nowrap;"
        >
            <span id="animationModeTitleTextMobile">fractal frenetics</span>
            <svg id="dropdownArrowMobile" class="w-2 h-2 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        
        <!-- Dropdown menu mobile -->
        <div 
            id="animationDropdownMobile"
            class="hidden absolute top-full left-1/2 transform -translate-x-1/2 mt-2 rounded-lg border-2 overflow-hidden"
            style="background-color: rgba(0, 0, 0, 0.35); border-color: var(--theme-hover-color); min-width: 180px;"
        >
            <div 
                class="animation-option-mobile px-3 py-1.5 transition-colors duration-200 cursor-pointer"
                style="color: #bae6fd;"
                data-mode="fractal"
            >fractal frenetics</div>
            <div 
                class="animation-option-mobile px-3 py-1.5 transition-colors duration-200 cursor-pointer"
                style="color: #D9BE4C;"
                data-mode="planets"
            >obstinate orbits</div>
            <div 
                class="animation-option-mobile px-3 py-1.5 transition-colors duration-200 cursor-pointer"
                style="color: #C4A574;"
                data-mode="sandfield"
            >rippling rhythms</div>
            <div 
                class="animation-option-mobile px-3 py-1.5 transition-colors duration-200 cursor-pointer"
                style="color: #FF6B9D;"
                data-mode="tron"
            >pageantic pursuers</div>
            <div 
                class="animation-option-mobile px-3 py-1.5 transition-colors duration-200 cursor-pointer"
                style="color: #A78BFA;"
                data-mode="portal"
            >galvanic gates</div>
        </div>
    </div>
    )}

    <!-- 
      Main Navigation Links (Desktop Layout)
      Horizontal list of page routes with active state highlighting and hover effects.
      Hidden on mobile devices; accessible through burger menu instead.
    -->
    <ul
        class="hidden absolute top-[48px] left-[100px] transform -translate-y-1/2 lg:flex lg:mx-auto lg:items-center lg:justify-start lg:w-auto lg:space-x-2 font-code"
    >
        <!-- About Me page navigation link with active state detection -->
        <li>
            <a
                class=`${(currentPath==="/about/") && "navIsActive"} dynamic-hover`
                id="aboutPage"
                href="/about/">about me</a
            >
        </li>
        <!-- Visual separator dot between navigation items -->
        <li class="text-gray-300">
            â€¢
        </li>

        <!-- Initiatives side-expanding menu -->
        <li class="relative">
            <button
                class=`${(currentPath==="/projects/") && "navIsActive"} dynamic-hover flex items-center cursor-pointer`
                id="initiativesToggle"
            >
                initiatives
                <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="initiativesArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            
            <!-- Side-expanding menu with circular icons -->
            <div class="absolute left-full ml-4 top-1/2 -translate-y-1/2 hidden" id="initiativesSidebar" style="z-index: 9999;">
                <div class="flex items-center gap-3 bg-silver dark:bg-silver rounded-full px-3 py-2 shadow-lg">
                    <!-- Projects icon/button -->
                    <a
                        class=`${(currentPath==="/projects/") && "navIsActive"} initiative-icon flex items-center justify-center bg-pearl rounded-full transition-all duration-300 cursor-pointer dynamic-hover`
                        href="/projects/"
                        data-label="projects"
                        style="width: 40px; height: 40px; overflow: hidden;"
                    >
                        <span class="font-bold text-silver dark:text-silver" style="white-space: nowrap;">p</span>
                    </a>
                    
                    <!-- Research icon/button -->
                    <a
                        class=`{${(currentPath==="/research/") && "navIsActive"} initiative-icon flex items-center justify-center bg-pearl rounded-full transition-all duration-300 cursor-pointer dynamic-hover`
                        href="/research/"
                        data-label="research"
                        style="width: 40px; height: 40px; overflow: hidden;"
                    >
                        <span class="font-bold text-silver dark:text-silver" style="white-space: nowrap;">r</span>
                    </a>
                    
                    <!-- Teaching icon/button -->
                    <a
                        class=`{${(currentPath==="/teaching/") && "navIsActive"} initiative-icon flex items-center justify-center bg-pearl rounded-full transition-all duration-300 cursor-pointer dynamic-hover`
                        href="/teaching/"
                        data-label="teaching"
                        style="width: 40px; height: 40px; overflow: hidden;"
                    >
                        <span class="font-bold text-silver dark:text-silver" style="white-space: nowrap;">t</span>
                    </a>
                </div>
            </div>
        </li>        <!-- 
          Final separator dot (currently disabled)
          No additional navigation links follow, so separator is not needed.
        -->        <!-- <li class="text-gray-300">
            <svg
                class="w-4 h-4 current-fill"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 5v0m0 7v0m0 7v0m0-13a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                ></path>
            </svg>
        </li> -->

        <!-- 
          Interests Navigation Link (Currently Disabled)
          Interests page exists but is hidden from main navigation at this time.
        -->
        <!-- <li>
            <a
                class=`${(currentPath==="/interests/") && "navIsActive"} hover:text-gold`
                id="interestsPage"
                href="/interests/">interests</a
            >
        </li> -->
    </ul>
</nav>

<!-- 
  Burger Menu Container (Mobile Navigation)
  Expandable overlay menu that slides in from the left on mobile devices.
  Hidden by default; toggled visible when burger icon is clicked.
-->
<div
    id="containerNavBarBurgerMenu"
    class="nav navbar-menu relative z-50 hidden"
>
    <!-- Semi-transparent backdrop overlay that closes menu when clicked -->
    <div class="navbar-backdrop fixed inset-0 bg-gray-800 opacity-25"></div>
    
    <!-- Slide-out navigation panel with logo, links, and close button -->
    <nav
        id="headerBurgerMenuOnAppear"
        class="fixed top-0 left-0 bottom-0 flex flex-col w-5/6 max-w-sm py-6 px-6 bg-black overflow-y-auto"
    >
        <div class="flex items-center mb-8">
            <!-- 
              Logo in burger menu header.
              Provides consistent branding and home navigation within mobile menu.
              Static display with no hover animation effect.
            -->
            <a class="mr-auto text-3xl font-bold leading-none focus:outline-none" href="/" style="-webkit-tap-highlight-color: transparent;">
                <div
                    class="relative w-[84px] h-[84px] duration-300 overflow-hidden"
                >
                    <!-- Background element for logo container -->
                    <div
                        class="absolute inset-0 transition-colors duration-300"
                    >
                    </div>

                    <!-- 
                      Static logo image displaying the left portion of the combined logo.
                      Uses black background variant for visibility against dark menu.
                      No hover effect - remains consistent across all states.
                      Starts with black background and fades in once image is loaded.
                    -->
                    <div
                        id="mobileLogoImage"
                        class="absolute inset-0 bg-no-repeat bg-left bg-cover rounded-full opacity-0 transition-opacity duration-300"
                        style="background-color: #000000; background-image: url('/media/home-logo.svg'); background-size: 200%;"
                    >
                    </div>
                </div>
            </a>

            <!-- 
              Close Button (X Icon)
              Collapses and hides the burger menu when clicked.
            -->
            <button class="navbar-close">
                <svg
                    class="h-6 w-6 text-gray-400 cursor-pointer hover:text-gray-500"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- 
          Navigation Links List (Mobile Menu)
          Vertical stacked layout with larger touch-friendly targets and active state highlighting.
        -->
        <div class="font-code text-2xl text-pearl">
            <ul>
                <!-- 
                  Home Link (Currently Disabled)
                  Removed since logo already provides home navigation.
                -->
                <!-- <li class="mb-1">
                    <a class=`${(currentPath==="/") && "navIsActiveMobile"} block p-4 font-semibold hover:bg-gray-50 hover:text-gold` href="/">home</a>
                </li> -->

                <!-- About Me page link with mobile-specific active state styling -->
                <li class="mb-1">
                    <a
                        class=`${(currentPath==="/about/") && "navIsActiveMobile"} block p-4 font-semibold hover:bg-gray-50 dynamic-hover`
                        href="/about/">about me</a
                    >
                </li>

                <!-- Initiatives dropdown section for mobile -->
                <li class="mb-1">
                    <button
                        class=`${(currentPath==="/projects/") && "navIsActiveMobile"} block w-full text-left p-4 font-semibold hover:bg-gray-50 dynamic-hover mobile-dropdown-toggle`
                        id="mobileInitiativesToggle"
                    >
                        initiatives
                        <svg class="w-4 h-4 inline-block ml-1 transition-transform duration-200" id="mobileDropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <!-- Submenu items -->
                    <div class="hidden pl-4" id="mobileInitiativesSubmenu">
                        <a
                            class=`${(currentPath==="/projects/") && "navIsActiveMobile"} block p-4 font-semibold hover:bg-gray-50 dynamic-hover`
                            href="/projects/">projects</a
                        >
                        <a
                            class=`${(currentPath==="/research/") && "navIsActiveMobile"} block p-4 font-semibold hover:bg-gray-50 dynamic-hover`
                            href="/research/">research</a
                        >
                        <a
                            class=`${(currentPath==="/teaching/") && "navIsActiveMobile"} block p-4 font-semibold hover:bg-gray-50 dynamic-hover`
                            href="/teaching/">teaching</a
                        >
                    </div>
                </li>

                <!-- 
                  Interests Link (Currently Disabled)
                  Interests page hidden from mobile navigation at this time.
                -->
                <!-- <li class="mb-1">
                    <a
                        class=`${(currentPath==="/interests/") && "navIsActiveMobile"} block p-4 font-semibold hover:bg-gray-50 hover:text-gold`
                        href="/interests/">interests</a
                    >
                </li> -->
            </ul>
        </div>

        <!-- 
          Footer Section in Burger Menu
          Displays a friendly closing message at the bottom of the navigation panel.
        -->
        <div class="mt-auto">
            <div class="pt-6"></div>
            <p class="my-4 text-xs text-center text-pearl">
                <span>Made with love. ðŸ’›</span>
            </p>
        </div>
    </nav>
</div>

<script is:inline>
    /**
     * Logo Image Preload Handler
     * 
     * Ensures logo images are fully loaded before displaying them to prevent white flash.
     * Fades in logos with smooth opacity transition once images are ready.
     */
    
    // Preload desktop logo image
    const desktopLogoImg = new Image();
    desktopLogoImg.src = '/media/home-logo.svg';
    desktopLogoImg.onload = () => {
        const logoElement = document.getElementById('desktopLogoImage');
        if (logoElement) {
            logoElement.style.opacity = '1';
        }
    };

    // Preload mobile logo image
    const mobileLogoImg = new Image();
    mobileLogoImg.src = '/media/home-logo.svg';
    mobileLogoImg.onload = () => {
        const logoElement = document.getElementById('mobileLogoImage');
        if (logoElement) {
            logoElement.style.opacity = '1';
        }
    };

    /**
     * Burger Menu Interaction Handler
     * 
     * Manages the open/close behavior of the mobile navigation menu.
     * Responds to clicks on the burger icon, close button, and backdrop overlay.
     */
    
    // DOM element references for burger menu components.
    const elementBurger = document.querySelector(".navbar-burger");
    const elementMenu = document.querySelector(".navbar-menu");
    const elementMenuCloseButton = document.querySelector(".navbar-close");
    const elementMenuBackdrop = document.querySelector(".navbar-backdrop");

    /**
     * Toggles the visibility state of the burger menu.
     * Adds or removes the 'hidden' class to show/hide the navigation panel.
     */
    const closeMenu = () => {
        elementMenu.classList.toggle("hidden");
    };

    // Toggle menu visibility when burger icon is clicked.
    elementBurger.addEventListener("click", () => {
        closeMenu();
    });

    // Close menu when the X button is clicked.
    elementMenuCloseButton.addEventListener("click", () => {
        closeMenu();
    });

    // Close menu when clicking outside the navigation panel on the backdrop overlay.
    elementMenuBackdrop.addEventListener("click", () => {
        closeMenu();
    });

    /**
     * Mobile Initiatives Dropdown Handler
     * 
     * Manages the expand/collapse behavior of the initiatives submenu in mobile view.
     */
    const mobileInitiativesToggle = document.getElementById("mobileInitiativesToggle");
    const mobileInitiativesSubmenu = document.getElementById("mobileInitiativesSubmenu");
    const mobileDropdownArrow = document.getElementById("mobileDropdownArrow");

    if (mobileInitiativesToggle && mobileInitiativesSubmenu) {
        // Check if we're on the projects page and auto-expand if so
        const currentPath = window.location.pathname;
        
        if (currentPath === '/projects/') {
            mobileInitiativesSubmenu.classList.remove("hidden");
            if (mobileDropdownArrow) {
                mobileDropdownArrow.style.transform = "rotate(180deg)";
            }
        }
        
        mobileInitiativesToggle.addEventListener("click", () => {
            mobileInitiativesSubmenu.classList.toggle("hidden");
            
            // Rotate arrow icon when dropdown is open
            if (mobileDropdownArrow) {
                mobileDropdownArrow.style.transform = mobileInitiativesSubmenu.classList.contains("hidden") 
                    ? "rotate(0deg)" 
                    : "rotate(180deg)";
            }
        });
    }

    /**
     * Desktop Initiatives Sidebar Handler
     * 
     * Manages the toggle and expansion behavior of the initiatives sidebar in desktop view.
     */
    const initiativesToggle = document.getElementById("initiativesToggle");
    const initiativesSidebar = document.getElementById("initiativesSidebar");
    const initiativesArrow = document.getElementById("initiativesArrow");

    if (initiativesToggle && initiativesSidebar) {
        // Auto-show sidebar if on projects page
        const currentPath = window.location.pathname;
        if (currentPath === '/projects/') {
            initiativesSidebar.classList.remove("hidden");
            if (initiativesArrow) {
                initiativesArrow.style.transform = "rotate(180deg)";
            }
        }
        
        // Toggle sidebar visibility on click
        initiativesToggle.addEventListener("click", (e) => {
            e.stopPropagation();
            const isHidden = initiativesSidebar.classList.contains("hidden");
            
            if (isHidden) {
                initiativesSidebar.classList.remove("hidden");
                if (initiativesArrow) {
                    initiativesArrow.style.transform = "rotate(180deg)";
                }
            } else {
                initiativesSidebar.classList.add("hidden");
                if (initiativesArrow) {
                    initiativesArrow.style.transform = "rotate(0deg)";
                }
            }
        });

        // Close sidebar when clicking outside
        document.addEventListener("click", (e) => {
            if (!initiativesToggle.contains(e.target) && !initiativesSidebar.contains(e.target)) {
                initiativesSidebar.classList.add("hidden");
                if (initiativesArrow) {
                    initiativesArrow.style.transform = "rotate(0deg)";
                }
            }
        });

        // Handle icon expansion on hover with persistent state
        const initiativeIcons = document.querySelectorAll(".initiative-icon");
        let currentlyExpandedIcon = null;
        
        initiativeIcons.forEach((icon) => {
            const label = icon.getAttribute("data-label");
            const textSpan = icon.querySelector("span");
            const originalText = textSpan.textContent;
            
            // Store original text for each icon
            icon.dataset.originalText = originalText;
            icon.dataset.label = label;
            
            icon.addEventListener("mouseenter", () => {
                // Collapse previously expanded icon if different
                if (currentlyExpandedIcon && currentlyExpandedIcon !== icon) {
                    const prevTextSpan = currentlyExpandedIcon.querySelector("span");
                    currentlyExpandedIcon.style.width = "40px";
                    currentlyExpandedIcon.style.paddingLeft = "0px";
                    currentlyExpandedIcon.style.paddingRight = "0px";
                    prevTextSpan.textContent = currentlyExpandedIcon.dataset.originalText;
                }
                
                // Expand current icon
                icon.style.width = "150px";
                icon.style.paddingLeft = "12px";
                icon.style.paddingRight = "12px";
                textSpan.textContent = label;
                currentlyExpandedIcon = icon;
            });
        });
        
        // Collapse expanded icon when leaving the sidebar entirely
        if (initiativesSidebar) {
            initiativesSidebar.addEventListener("mouseleave", () => {
                if (currentlyExpandedIcon) {
                    const textSpan = currentlyExpandedIcon.querySelector("span");
                    currentlyExpandedIcon.style.width = "40px";
                    currentlyExpandedIcon.style.paddingLeft = "0px";
                    currentlyExpandedIcon.style.paddingRight = "0px";
                    textSpan.textContent = currentlyExpandedIcon.dataset.originalText;
                    currentlyExpandedIcon = null;
                }
            });
        }
    }
    /**
     * Animation Mode Title Dropdown Handler
     * 
     * Manages dropdown menu for selecting specific animation modes.
     * Includes backspace/retype animation effect on mode change.
     * Dispatches hover events to slow down animation when dropdown is active.
     */
    
    // Map theme names to display titles
    const themeToTitle = {
        'fractals': 'fractal frenetics',
        'planets': 'obstinate orbits',
        'sandfield': 'rippling rhythms',
        'tron': 'pageantic pursuers',
        'portal': 'galvanic gates'
    };
    
    // Track dropdown state
    let isDropdownOpen = false;
    
    // Track if animation is in progress
    let isAnimating = false;
    
    // Function to animate backspace effect
    function backspaceAnimation(element, callback) {
        const currentText = element.textContent;
        let index = currentText.length;
        
        const backspaceInterval = setInterval(() => {
            if (index > 0) {
                element.textContent = currentText.substring(0, index - 1);
                index--;
            } else {
                clearInterval(backspaceInterval);
                if (callback) callback();
            }
        }, 10); // 10ms per character for backspace
    }
    
    // Function to animate typing effect
    function typeAnimation(element, targetText, callback) {
        let index = 0;
        
        const typeInterval = setInterval(() => {
            if (index < targetText.length) {
                element.textContent = targetText.substring(0, index + 1);
                index++;
            } else {
                clearInterval(typeInterval);
                if (callback) callback();
            }
        }, 15); // 15ms per character for typing
    }
    
    // Function to update border color during transition
    function updateBorderColor(containerElement, newColor) {
        if (containerElement) {
            containerElement.style.borderColor = newColor;
        }
    }
    
    // Get theme color map for border transitions
    const themeToColor = {
        'fractals': '#bae6fd',
        'planets': '#D9BE4C',
        'sandfield': '#C4A574',
        'tron': '#FF6B9D',
        'portal': '#A78BFA'
    };
    
    // Function to update the animation mode title with backspace/retype animation
    function updateAnimationTitle(animate = true) {
        if (isAnimating && animate) return; // Prevent overlapping animations
        
        const currentTheme = localStorage.getItem('theme') || 'fractals';
        const titleText = themeToTitle[currentTheme] || themeToTitle['fractals'];
        const newBorderColor = themeToColor[currentTheme] || themeToColor['fractals'];
        
        const desktopTitleElement = document.getElementById('animationModeTitleText');
        const mobileTitleElement = document.getElementById('animationModeTitleTextMobile');
        const desktopContainer = document.getElementById('animationModeTitle');
        const mobileContainer = document.getElementById('animationModeTitleMobile');
        
        if (!animate) {
            // Direct update without animation (for initial load)
            if (desktopTitleElement) desktopTitleElement.textContent = titleText;
            if (mobileTitleElement) mobileTitleElement.textContent = titleText;
            updateBorderColor(desktopContainer, newBorderColor);
            updateBorderColor(mobileContainer, newBorderColor);
            return;
        }
        
        // Skip if text hasn't changed
        if (desktopTitleElement && desktopTitleElement.textContent === titleText) {
            return;
        }
        
        isAnimating = true;
        
        // Animate desktop version
        if (desktopTitleElement) {
            backspaceAnimation(desktopTitleElement, () => {
                updateBorderColor(desktopContainer, newBorderColor);
                typeAnimation(desktopTitleElement, titleText, () => {
                    isAnimating = false;
                });
            });
        }
        
        // Animate mobile version
        if (mobileTitleElement) {
            backspaceAnimation(mobileTitleElement, () => {
                updateBorderColor(mobileContainer, newBorderColor);
                typeAnimation(mobileTitleElement, titleText, () => {});
            });
        }
    }
    
    // Update title on page load (without animation)
    updateAnimationTitle(false);
    
    // Listen for storage events to detect theme changes from other tabs/windows
    window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
            updateAnimationTitle(true);
        }
    });
    
    // Also listen for custom event that can be dispatched when theme changes
    window.addEventListener('themeChange', () => {
        updateAnimationTitle(true);
    });
    
    // Poll for theme changes (as a fallback since storage events don't fire in same tab)
    let lastTheme = localStorage.getItem('theme') || 'fractals';
    setInterval(() => {
        const currentTheme = localStorage.getItem('theme') || 'fractals';
        if (currentTheme !== lastTheme) {
            lastTheme = currentTheme;
            updateAnimationTitle(true);
        }
    }, 100); // Check every 100ms
    
    /**
     * Dropdown Toggle and Mode Selection Handlers
     */
    const desktopTitleButton = document.getElementById('animationModeTitleButton');
    const mobileTitleButton = document.getElementById('animationModeTitleButtonMobile');
    const desktopDropdown = document.getElementById('animationDropdown');
    const mobileDropdown = document.getElementById('animationDropdownMobile');
    const dropdownArrow = document.getElementById('dropdownArrow');
    const dropdownArrowMobile = document.getElementById('dropdownArrowMobile');
    const desktopTitleContainer = document.getElementById('animationModeTitle');
    const mobileTitleContainer = document.getElementById('animationModeTitleMobile');
    
    // Function to toggle dropdown
    function toggleDropdown(isMobile = false) {
        const dropdown = isMobile ? mobileDropdown : desktopDropdown;
        const arrow = isMobile ? dropdownArrowMobile : dropdownArrow;
        
        if (!dropdown || !arrow) return;
        
        isDropdownOpen = !dropdown.classList.contains('hidden');
        
        if (isDropdownOpen) {
            // Close dropdown
            dropdown.classList.add('hidden');
            arrow.style.transform = 'rotate(0deg)';
            isDropdownOpen = false;
            // Notify DynamicBGAnim that dropdown is closed
            window.dispatchEvent(new CustomEvent('animationDropdownToggle', { detail: { isOpen: false } }));
        } else {
            // Open dropdown
            dropdown.classList.remove('hidden');
            arrow.style.transform = 'rotate(180deg)';
            isDropdownOpen = true;
            // Notify DynamicBGAnim that dropdown is open
            window.dispatchEvent(new CustomEvent('animationDropdownToggle', { detail: { isOpen: true } }));
        }
    }
    
    // Desktop button click handler
    if (desktopTitleButton) {
        desktopTitleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(false);
        });
    }
    
    // Mobile button click handler
    if (mobileTitleButton) {
        mobileTitleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(true);
        });
    }
    
    // Handle hover events for slowdown effect
    if (desktopTitleContainer) {
        desktopTitleContainer.addEventListener('mouseenter', () => {
            window.dispatchEvent(new Event('animationTitleHoverStart'));
        });
        desktopTitleContainer.addEventListener('mouseleave', () => {
            window.dispatchEvent(new Event('animationTitleHoverEnd'));
        });
    }
    
    if (mobileTitleContainer) {
        mobileTitleContainer.addEventListener('mouseenter', () => {
            window.dispatchEvent(new Event('animationTitleHoverStart'));
        });
        mobileTitleContainer.addEventListener('mouseleave', () => {
            window.dispatchEvent(new Event('animationTitleHoverEnd'));
        });
    }
    
    // Desktop dropdown option click handlers
    const desktopOptions = document.querySelectorAll('.animation-option');
    desktopOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            e.stopPropagation();
            const mode = option.getAttribute('data-mode');
            if (mode) {
                // Dispatch event to switch to specific mode
                window.dispatchEvent(new CustomEvent('switchToSpecificMode', { detail: { mode } }));
                // Close dropdown
                toggleDropdown(false);
            }
        });
        
        // Hover effect for options
        option.addEventListener('mouseenter', () => {
            option.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        });
        option.addEventListener('mouseleave', () => {
            option.style.backgroundColor = 'transparent';
        });
    });
    
    // Mobile dropdown option click handlers
    const mobileOptions = document.querySelectorAll('.animation-option-mobile');
    mobileOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            e.stopPropagation();
            const mode = option.getAttribute('data-mode');
            if (mode) {
                // Dispatch event to switch to specific mode
                window.dispatchEvent(new CustomEvent('switchToSpecificMode', { detail: { mode } }));
                // Close dropdown
                toggleDropdown(true);
            }
        });
        
        // Hover effect for options
        option.addEventListener('mouseenter', () => {
            option.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        });
        option.addEventListener('mouseleave', () => {
            option.style.backgroundColor = 'transparent';
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (desktopDropdown && !desktopDropdown.classList.contains('hidden')) {
            toggleDropdown(false);
        }
        if (mobileDropdown && !mobileDropdown.classList.contains('hidden')) {
            toggleDropdown(true);
        }
    });
</script>
